<!DOCTYPE html>
<html>
<head>
<title>Vue源码分析 - 幕布</title>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="renderer" content="webkit"/>
<meta name="author" content="mubu.com"/>
</head>
<body style="margin: 50px 20px;color: #333;font-family: SourceSansPro,-apple-system,BlinkMacSystemFont,'PingFang SC',Helvetica,Arial,'Microsoft YaHei',微软雅黑,黑体,Heiti,sans-serif,SimSun,宋体,serif">
<div class="export-wrapper"><div style="font-size: 22px; padding: 0 15px 0;"><div style="padding-bottom: 24px">Vue源码分析</div><div style="background: #e5e6e8; height: 1px; margin-bottom: 20px;"></div></div><ul style="list-style: outside disc;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">Vue源码分析</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li class="collapsed" style="line-height: 24px;"><span class="content mubu-node collapsed" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">Vue初始化函数，new Vue()之前</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li class="collapsed" style="line-height: 24px;"><span class="content mubu-node collapsed" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createPatchFunction 传nodeOps对象和modules对象进去</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">nodeOps对象 （主要是一些dom的操作方法） <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#patch</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createElement$1 创建一个真实的dom,会判断是否为select标签，若是，判断是否有multiple属性</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createElementNS 创建一个真实的dom，SVG方式</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createTextNode 创建文本节点dom</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createComment 创建注释节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">insertBefore 插入节点 在referenceNode&nbsp; dom 前面插入一个节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">removeChild 删除子节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">appendChild 添加节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">parentNode 父节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">nextSibling 获取下个兄弟节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">tagName 获取dom标签名</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">setTextContent设置dom 文本</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">setStyleScope设置组建样式的作用域</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">modules --由两个数组组成  <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#patch</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">platformModules</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">attrs 里面是更新/设置dom的属性的方法</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在钩子函数invokeCreateHooks()中调用</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">create</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">update</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">klass 里面是更新、设置class的方法</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create和update，其实就是updateClass方法</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">updateClass()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">获取vnode中的data.staticClass和data.class</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genClassForVnode() 转换class</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">将组件中class数据转换成dom的class字符串格式。使用while循环，如何childNode.componentInstance子组件已经实例化或parentNode.parent父组件存在就使用mergeClassData()合并他们的class</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">mergeClassData() 合并class</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">静态class,child.staticClass与 parent.staticClass合并。动态class：child.class,与parent.class合并。最后返回对象{staticClass，class}</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">renderClass() 渲染class</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">使用stringifyClass把对象class转换成dom的class</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">stringifyClass()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">使用stringifyArray() 处理数组类型class对象</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">使用stringifyObject() 处理对象类型class对象</span></li></ul></li></ul></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">events 更新、设置dom事件</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create和update，其实都是updateDOMListeners()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">updateDOMListeners()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">先判断有没有定义了事件on，若无就return</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">normalizeEvents(on) </span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">特殊处理ie浏览器input[type=range] 给dom添加change，input事件</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">updateListeners</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">更新数据源，添加新函数，删除旧事件。包括cur静态类，enent.once,event.capture捕获冒泡等</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">domProps 更新、设置dom的props</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create和update 其实都是updateDOMProps()</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">style 更新、设置dom的style</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create和update 其实都是updateStyle</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">transition 处理动画属性，里面有三个方法（此处略）</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create、activeate、remove</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">baseModules</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">ref:  ref的创建更新销毁函数</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create、update、destroy。其中upadte是先删除ref，再添加ref,主要函数都是registerRef ()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">registerRef 注册ref或者删除ref。比如设置了ref="abc" 那么就注册，vm.$refs.abc 就是真实dom</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">directives：自定义指令的创建更新销毁函数</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">create、update、destroy都是updateDirectives()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">updateDirectives()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">若vnode存在，先比较oldVnode 和vnode,根据情况触发指令钩子函数callHook$1()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">normalizeDirectives$1()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">规范化指令，修正指令属性并返回</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">callHook$1()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">触发指令钩子函数bind，update，inserted，insert，componentUpdated，unbind</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">isCreate  是否第一次创建指令</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">如果isCreate为真，则insert，如果dirsWithPostpatch.length大于0 则使用mergeVNodeHook()合并postpatch</span></li></ul></li></ul></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">strats类  （合并配置数据(vue.options)时使用 mergeOptions().在vue.mixin()或new Vue 初始化或子组件构造中都会执行） <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#合并配置</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">有方法el,propsData,data,provide,watch,props,methods,inject,computed,components,directives,filters,strats类里的方法都是合并数据。如果没有子节点childVal,就返回父节点parentVal。如果有就返回子节点childVal</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">strats.el = starts.propsData </span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">判断vm是否有实例化，没有就警告 ‘。。。。new keyword’。如有就判断有没有子节点，若有就返回子，无就返回父节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">strats.data,strats.provide  </span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">利用mergeDataOrFn() 递归深度拷贝数据并合并，是否有vm，是否有childVal，是否有parentVal等判断处理。childVal不是function的话会警告‘The&nbsp;"data"&nbsp;option&nbsp;should&nbsp;be&nbsp;a&nbsp;function。。。’</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">strats.watch</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">循环childVal 。获取childVal 的key，若parentVal上存在，则取parentVal的，若无变成数组存在ref对象中</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">strats.props = starts.methods=strats.inject&nbsp;=&nbsp;strats.computed</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">利用extend()对象克隆对象</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">LIFECYCLE_HOOKS</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">生命周期钩子，遍历添加进strats</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"beforeCreate",&nbsp;//&nbsp;&nbsp;生命周期&nbsp;开始实例化&nbsp;vue&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"created",&nbsp;//生命周期&nbsp;&nbsp;&nbsp;结束实例化完&nbsp;vue&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"beforeMount",&nbsp;//生命周期&nbsp;开始渲染虚拟dom&nbsp;，挂载event&nbsp;事件&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"mounted",&nbsp;//生命周期&nbsp;&nbsp;渲染虚拟dom&nbsp;，挂载event&nbsp;事件&nbsp;完&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"beforeUpdate",&nbsp;//生命周期&nbsp;&nbsp;开始更新wiew&nbsp;数据指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"updated",&nbsp;//生命周期&nbsp;&nbsp;结束更新wiew&nbsp;数据指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"beforeDestroy",&nbsp;//生命周期&nbsp;&nbsp;开始销毁&nbsp;new&nbsp;实例&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"destroyed",&nbsp;//生命周期&nbsp;&nbsp;结束销毁&nbsp;new&nbsp;实例&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"activated",&nbsp;//keep-alive组件激活时调用。</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"deactivated",&nbsp;//deactivated&nbsp;keep-alive组件停用时调用。</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"errorCaptured",&nbsp;//&nbsp;具有此钩子的组件捕获其子组件树（不包括其自身）中的所有错误（不包括在异步回调中调用的那些）。</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">ASSET_TYPES</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">内置指令，遍历添加进strats</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"component",&nbsp;//组建指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"directive",&nbsp;//定义指令&nbsp;指令</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">"filter",&nbsp;//过滤器指令</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">为Vue prototype添加方法</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">_init， set，$delete，$watch，$on，$once ，$off，$emit，update，$forceUpdate，$destroy,_o,_n,_s,_l,_t,_q,_i,_m,_f,_k,_b,_v,_e,_u,_g ， $nextTick ，_render的方法，在在一万多行中又添加了__patch__和$mount方法</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initMixin <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#合并配置</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">为Vue prototype 添加_init方法，vue构造函数实例化对象时（即 new Vue()）调用</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">stateMixin</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">添加set, $delete, $watch</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">eventsMixin</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">添加$on, $once, $off, $emit</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">lifecycleMixin <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#update</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">添加_update, $forceUpdate, $destory</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">renderMixin</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">添加$nextTick, _render  <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#render函数生成vnode</span></span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initGlobalAPI 为Vue添加静态方法和属性</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">静态方法有set，delete，nextTick，use，mixin，extend，component，directive，filter&nbsp;</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">利用defineProperty设置Vue.config属性 修改的话就警告</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">Do&nbsp;not&nbsp;replace&nbsp;the&nbsp;Vue.config&nbsp;object,&nbsp;set&nbsp;individual&nbsp;fields&nbsp;instead.</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">mustUseProp 校验属性</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">isReservedTag 判断是否HTML原有标签或svg标签</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">isReservedAttr 校验属性是否为style，clsss</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">getTagNamespace 判标签是否为svg标签或match标签</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">isUnknownElement  判断是否为用户自定义标签</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">添加Vue.util</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">添加Vue.set 静态方法 用于更新视图</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">添加Vue.delete 用于删除数据</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">添加Vue.nextTick 用于视图更新后回调</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">添加Vue.options属性 </span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">遍历ASSET_TYPES，添加内置指令component，directive，filter&nbsp;</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initUse() 安装插件</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initMixin$1() 合并参数</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initExtend() </span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initAssetRegisters()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">为vue&nbsp;添加&nbsp;静态方法component，directive，，filter</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createCompilerCreator (<span class="bold" style="font-weight: bold;">baseCompile</span>) 创建编译器 <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#编译入口</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">返回一个createCompiler编译函数，函数柯里化编程，缓存参数baseCompile基本的编译函数，在最后compile()函数调用。</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">返回一个函数createCompiler(baseOptions)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在此定义compile函数，然后作为参数传进返回的函数createCompileToFunctionFn</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">返回一个对象{compile, compileToFunctions: createCompileToFunctionFn(<span class="bold" style="font-weight: bold;">compile</span>)}</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">其中createCompileToFunctionFn(compile) 返回最终编译函数compileToFunctions(​template: string,options?: CompilerOptions,vm?: Component&nbsp;)</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">compileToFunctions()也就是createCompileToFunctionFn(compile)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">接收3个参数编译模板template，编译配置options，和vue实例 vm</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心是 const compiled = <span class="bold" style="font-weight: bold;">compile</span>(template, options) <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#编译</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">compile函数先处理配置参数，真正执行编译过程是baseCompile()函数，通过createCompilerCreator()传进来的参数</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">compile函数核心 const compiled = <span class="bold" style="font-weight: bold;">baseCompile</span>(template, finalOptions)&nbsp;</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">先执行parse(template.trim(),&nbsp;options)生成返回ast模板对象</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">AST元素节点有3种，type为1是普通元素，2为表达式，3为纯文本。个人认为这里使用常亮表达式更直观</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">再利用optimize(ast,&nbsp;options)对ast树进行优化</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">深度遍历ast树，检测每个子树是不是静态节点，若是就生成的DOM不需要改变</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">markStatic(root) 标记静态节点 </span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">&nbsp;通过isStatic(node)函数来判断，（会递归遍历子节点，如有一个子节点非静态，那么父也不是静态）</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">纯文本（type为3）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">普通元素（type为1）</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">1、没有pre属性</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">（node.pre）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">2、同时满足以下：</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">没有使用v-if,-v-for；</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">（!node.if &amp;&amp; !node.for）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">没有使用其他特殊指令（v-once），</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">非内置组件；</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">（!isBuiltInTag(node.tag)）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">是平台保留标签；</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">（isPlatformReservedTag(node.tag)）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">非带有v-for的template标签的直接子节点；</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">（!isDirectChildOfTemplateFor(node)）</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">节点所有属性的key都满足静态</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">key（Object.keys(node).every(isStaticKey)）</span></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">&nbsp;markStaticRoots(root, false) 标记静态根</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">本身是一个静态节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">必须拥有children，且children不能只是一个文本节点</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">不然的话标记的收益太小了</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">最后利用generate(ast, options)对优化过的AST树转换成可执行代码  <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#render代码串的由来</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">判断当前AST节点的属性执行不同的代码生成函数</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心是genElement(el, state)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">返回code，再把code用with(this){return ${code}}} 包裹起来就是返回出去的render。最后通过new Function d的方式转换成可执行代码赋值给vm.options.render。根据el判断是否为组件，是否含有v-once,v-if,v-for,template属性,slot插槽,转换style，css等执行不同函数</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genStatic(el, state)&nbsp;</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genOnce(el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genFor(el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genIf(el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genChildren(el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genSlot(el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">&nbsp;genComponent(el.component, el, state)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genData(el, state)&nbsp;</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">是根据 AST 元素节点的属性构造出⼀个 data 对象字符串，这个在后⾯创建VNode 的时候的时候会作为参数传⼊，参数二state 使用了state.dataGenFns(el),遍历获取所有 modules 中的 genData 函数</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">genChildren(el, state, true)</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">编译入口有点绕的原因，函数柯里化</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">​vue在不同平台下都会有编译，因此编译过程依赖的配置baseOptions也会有所不同，而编译过程会执行多次，同一平台每一次编译配置又相同，为了不让这些配置baseOptions每次编译都通过参数传进来。就利用函数柯里化把参数baseOptions保留。</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">利用函数柯里化的方式吧基础的编译过程函数抽出来，通过​createCompilerCreator (baseCompile)的方式把真正编译的过程和其他逻辑，例如对配置的处理，缓存处理等分离</span></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">new Vue()实例化对象 （new Vue --&gt; init --&gt; $mount --&gt; compile --&gt; render --&gt; vnode --&gt; patch --&gt;dom）</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">调用_init(options),创建 vm.uid</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">判断_isComponent</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">若是，优化内部组件 initInternalComponent(vm,&nbsp;options);</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">若否，调用mergeOptions()合并参数到vm.options,</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initProxy(vm) <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#变量方法未定义错误</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化代理监听​，判断是否支持Proxy,生成环境中vm._renderProxy = vm.在模板中使用未定义变量就报错：Property or method xxx is not defined on the instance but.....​</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initLifecycle(vm)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化生命周期,添加vm.$parent ,$refs, $root, $children, _isMounted, vm._watcher, vm._isDestroyed等属性和标记</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initEvents(vm)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化事件</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initRender(vm) <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#render函数生成vnode</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化渲染，产生vnode。添加$slots,$scopeSlots,renderContext, _staticTrees 等属性或对象。同时添加_c和$createElement两个渲染方法。并且吧$attr属性和$listeners事件属性添加到defineReactive观察者中，监听数据只读</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">vm._c(),</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">被模板编译成的render函数使用，核心是createElement(),生成返回vnode</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">vm.$createElement() <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#render函数生成vnode</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">用户手写render方法使用, 核心也是createElement(),只是最后一个参数不同，生成返回vnode</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createElement () 是对 _createElement()的参数进行处理后的封装</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">判断data.__ob__是否存在,存在说明data是被observe的数据，不能作为标签数据，发出警告并返回一个空节点createEmptyVNode()。</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">被observe的data不能用作vnode渲染是数据原因：data在渲染过程中可能会被改变，这时会触发监控导致其他问题</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">判断data数据是否有（<a class="content-link" target="_blank" href="http://data.is" style="text-decoration: underline; opacity: 0.6; color: inherit;">data.is</a>），若是就直接赋值给tag</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">参数children的规范化</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">根据参数normalizationType分成2种</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">normalizeChildren()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">场景一：render函数是用户手写的，children只有一个节点且是文本节点。这时调用createTextVNode</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">场景二：编译到slot, v-for的时候会产生嵌套数组的情况，调用normalizeArrayChildren()遍历递归children</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">simpleNormalizeChildren()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">render函数是有模板编译生成的，children已经是vnode类型，且只有一个根节点</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">例外：function component 函数式组件返回的是一个数组而不是一个根节点。所以要通过Array.prototype.concat方法把children降成一层</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">vnode 的创建</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">对tag进行判断，tag是string</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">是一个内置节点，HTML标签，直接创建一个普通VNode</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">new VNode(config.parsePlatformTagName(tag), data, children,undefined, undefined, context)&nbsp;</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">是已注册组件名 <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#组件化</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">通过createComponent()创建一个组件类型Vnode</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">tag是一个Component类型 <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#组件化</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createComponent( Ctor: Class | Function | Object | void, data: ?VNodeData, context: Component, children: ?Array, tag?: string ): VNode | Array | void</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">同步组件</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">构造子类构造函数</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">const baseCtor = context.$options._base，此处的baseCtor就是Vue</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">baseCtor.extend(Ctor)，就是Vue.extend()</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">构造一个Vue的子类，Ctor就是我们写.vue文件中export 出去的{name: xxx, components:{xxx}}</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">const Sub = function VueComponent (options) { this._init(options) }&nbsp;实例化一个Vue的构造器Sub.这里会再次走Vue实例化的过程，所以_init()执行了2次，一开始vm._uid为2</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">Sub.prototype = Object.create(Super.prototype) Sub.prototype.constructor = Sub</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">使用原型继承把一个纯对象转换一个继承Vue的构造器Sub并返回</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">对Sub扩展属性options，添加全局api，初始化props和computed</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">缓存Sub,避免多次执行Vue.extend的时候对同一子组件重复构造</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">installComponentHooks(data)&nbsp; ，安装组件钩子函数</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">把componentVNodeHooks的钩子函数合并到data.hook中，在patch的过程中执行相关钩子函数 <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#组件钩子函数</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在合并过程会通过mergeHook()把相同名称钩子合并，其实就是把它们都依次执行一次</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">new VNode() 实例化vnode</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">这里跟普通元素的Vnode不同，<span class="bold" style="font-weight: bold;">component的Vnode是没有children的</span></span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" images="%5B%7B%22id%22%3A%221b7171babb76430d8-6547260%22%2C%22oh%22%3A435%2C%22ow%22%3A388%2C%22uri%22%3A%22document_image%2Fadd32db3-e7ea-4d16-b420-1552a2ea9dc5-6547260.jpg%22%2C%22w%22%3A251%7D%5D" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">异步加载组件有三种方式 resolveAsyncComponent</span><div style="padding: 3px 0"><img src="https://mubu.com/document_image/add32db3-e7ea-4d16-b420-1552a2ea9dc5-6547260.jpg" style="max-width: 720px; width: 251px;" class="attach-img"></div><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">会根据不同方式返回不同的值（loadingComp, undefined等），如果是undefined就创建一个注释节点作为占位符。再次执行patch过程</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">工厂函数  Ctor&nbsp;=&nbsp;resolveAsyncComponent(asyncFactory,&nbsp;baseCtor);</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">如果是工厂函数方式，第一次就返回的是undefined，进入下面if逻辑。生成一个注释节点作为占位符。之后执行一次_update(),patch过程。这时第二次走到这里，不过此时factory.resolved已经不为空了，作为返回值赋给给构造器，往下就是正常同步patch逻辑了</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">Promise </span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">高级异步组件</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">callHook(vm,&nbsp;"beforeCreate")</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">触发beforeCreate钩子函数，也就是说此时还不能获取data，props的数据</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">initInjections(vm)</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在data,props之前解决注入问题，初始化inject</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initState(vm)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化状态,也就是初始化 props 、 data 、 methods 、 watch 、 computed 等属性</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initProps(vm, props)</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">检查props数据格式是否符合规范，若符合就添加到观察者队列中</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initMethods(vm, methods)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initData(vm)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initComputed(vm,computed)</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">initWatch(vm,watch)</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">initProvide(vm)</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在data,props之后，初始化provide</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">callHook(vm,&nbsp;"created")</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">触发created钩子函数,这时还没有DOM</span></li></ul></li><li class="collapsed" style="line-height: 24px;"><span class="content mubu-node collapsed" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">vm.$mount(vm.$options.el)</span>, 挂载实例</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">$mount 方法有多个，跟平台、构建方式（ssr）都相关.一下是带compiler版本的$mount</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">一开始先缓存原型上的$mount方法，再重新的定义</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">对el的限制，不能挂载在body，html等根节点上</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">如果没有定义render方法，把el或者template字符串转换成render方法</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在vue2中，所有vue组件的渲染最终都要render方法，无论是.vue文件，还是写el或者template属性</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">最后调用原先原型上的$mount方法挂载（一开始先缓存起来，这样可以复用）</span></li><li class="collapsed" style="line-height: 24px;"><span class="content mubu-node collapsed" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心方法 <span class="bold" style="font-weight: bold;">mountComponent</span>(vm: Component, el: ?Element, hydrating?: boolean)</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">实例化一个<span class="bold" style="font-weight: bold;">渲染watcher</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">这里watcher的作用一个是初始化时会执行回调函数，另个一是vm实例中监测到数据发生变化时执行回调函数，从而更新dom</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">回调函数中调用<span class="bold" style="font-weight: bold;">updateComponent()</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">调用vm._render() 生成vnode <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#render函数生成vnode</span></span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心是调用_createElement(),具体看initRender（点击标签）</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">调用<span class="bold" style="font-weight: bold;">vm.update()</span> 更新DOM <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#update</span> <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#patch</span></span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">初始化跟数据更新会调用</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心是调用<span class="bold" style="font-weight: bold;">vm.__patch__ </span> 返回dom给vm.$el</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">利用函数柯里化，把不同平台的配置独立出来通过参数传入，同时只需首次调用处理，之后在调用已经是判断处理过的</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">组件的patch</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">整体流程：createComponent&nbsp;(vnode, insertedVnodeQueue, parentElm, refElm)--&gt; 子组件初始化 --&gt;子组件render <span class="tag" style="text-decoration: underline; opacity: 0.6; color: inherit;">#组件化</span> --&gt;子组件patch</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">activeInstance 为当前激活的vm实例；</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">vm.$vnode = _parentVnode为组件占位符vnode (例如&lt;HelloWorld/&gt;)。vm._vnode是组件渲染的vnode (例如helloworld组件本身)</span></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">createPatchFunction({nodeOps,modules})</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">定义了一堆辅助方法，同时把传进来的差异化参数提前固化，处理后返回patch()。这样不用每次调用patch()都要把nodeOps跟modules传入</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">若传进来的是真实dom,要先转换成vnode对象</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">核心<span class="bold" style="font-weight: bold;">createEle</span>(vnode, insertedVnodeQueue, parentElm, refElm, nested, ownerArray, index&nbsp;)，regElm是参考节点</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">通过vnode 创建真实Dom并插入到父节点中，利用document.createElement()</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" color="#ffaf38" style="color: rgb(255, 175, 56); line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;"><span class="bold" style="font-weight: bold;">createChildren() </span>遍历子虚拟节点，递归调用createEle(),把自己（vnode.elm）作为父参。所以vnode插入是先子后父。<span class="bold" style="font-weight: bold;">故对于同步渲染的子组件来说，mounted，和</span>&nbsp;destroy&nbsp;<span class="bold" style="font-weight: bold;">钩子函数的执行顺序也是先子后父</span></span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">insert(parentElm, vnode.elm, refElm) 插入到父节点或根据参考节点refElm插入。</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">这里利用的是原生api。node.appendChild(child)跟parentNode.inserBefore(newNode, referenceNode)，</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li class="collapsed" style="line-height: 24px;"><span class="content mubu-node collapsed" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">destroy 销毁组件</span><ul class="children" style="list-style: outside disc; padding-bottom: 4px;"><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">callHook(vm, 'beforeDestroy') 一开始执行beforeDestroy钩子函数</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">从parent的$children中删除自身</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">删除watcher</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">vm.__patch__(vm._vnode, null)&nbsp; 当前渲染的vnode执行销毁钩子函数</span></li><li style="line-height: 24px;"><span class="content mubu-node" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">callHook(vm, 'destroyed') 调用destroy钩子函数</span><br><span class="note" style="display: inline-block; color: rgb(136, 136, 136); line-height: 22px; min-height: 22px; font-size: 14px; padding-bottom: 2px;">在$destroy的执行中递归invokeDestroyHook，会再次执行vm.__patch__(vm._vnode, null)触发它的子组件销毁钩子函数。所以也是执行顺序也是先子后父</span></li></ul></li></ul></li><li style="line-height: 24px;"><span class="content mubu-node" images="%5B%7B%22id%22%3A%22e9171b961f26f159-6547260%22%2C%22oh%22%3A3039%2C%22ow%22%3A1200%2C%22uri%22%3A%22document_image%2Ff34a8996-dbce-428b-bed6-5d1a0f2bffaf-6547260.jpg%22%2C%22w%22%3A462%7D%5D" style="line-height: 24px; min-height: 24px; font-size: 16px; padding: 2px 0px; display: inline-block; vertical-align: top;">生命周期</span><div style="padding: 3px 0"><img src="https://mubu.com/document_image/f34a8996-dbce-428b-bed6-5d1a0f2bffaf-6547260.jpg" style="max-width: 720px; width: 462px;" class="attach-img"></div></li></ul></li></ul></div>

</body>
</html>